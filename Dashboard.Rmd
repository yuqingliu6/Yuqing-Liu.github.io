---
title: "NYC Restaurant Inspections Dashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    source: embed 
---

```{r setup, include=FALSE}
library(flexdashboard)
library(p8105.datasets)
library(tidyverse)
library(plotly)
library(lubridate)
```

Column {data-width=650}
-----------------------------------------------------------------------

### Chart A

```{r}
data("rest_inspec")
rest_inspec |> 
  janitor::clean_names() |>
  mutate(inspection_date <- as.Date(inspection_date)) |>
  filter(inspection_date >= as.Date("2014-01-01"), 
         score != "Missing", score >= 0, boro != "Missing") |>
  mutate(year = year(inspection_date)) |>
  mutate(grade = case_when(0 <= score & score <= 13 ~ "A",
                         14 <= score & score <= 27 ~ "B",
                         score >= 28 ~ "C")) |>
  group_by(boro,grade, year) |>
  summarise(Count = n()) |>
  rename(Grade = grade) |>
  plot_ly(x = ~boro, y = ~Count, color = ~Grade, 
          frame = ~year, type = "bar", alpha = 1) |> 
  layout(title = 
           "Number of Restaurants in Each Inspection Grade Level by Borough in New York City, 2014-2017",
         xaxis = list(title = "Borough"),
         yaxis = list(title = "Count"),
         font = list(size = 12))
```

Column {data-width=350}
-----------------------------------------------------------------------

### Chart B


```{r}
rest_inspec |>
  filter(violation_code %in% c("06C", "06D", "06E", "06A","06F")) |>
  group_by(cuisine_description, violation_code) |>
  summarise(count = n()) |>
  ungroup() |>
  filter(count > 500) |>
  mutate(violation_code = recode(violation_code,"06D" = "Food contact surface not properly washed, rinsed and sanitized","06C" = "Food not protected from potential source of contamination", "06F" = "Wiping cloths soiled or not stored in sanitizing solution", "06A" = "Personal cleanliness inadequate", "06E"= "Sanitized equipment or utensil improperly used or stored.")) |>
  mutate(cuisine_description = fct_reorder(cuisine_description, count, .desc = FALSE)) |>
  mutate(cuisine_description = recode(cuisine_description,"Latin (Cuban, Dominican, Puerto Rican, South & Central American)" = "Latin" )) |>
 plot_ly(height = 300, 
   y = ~cuisine_description, x = ~count,
          color = ~violation_code, type = "bar", alpha = 1, orientation = 'h') |>
  layout(title = "Top 12 Cuisine Types with highest Sanitary Violation Numbers in New York City",
         xaxis = list(title = "Count"),
         yaxis = list(title = "Cuisine"),
         font = list(size = 8))
  
```

### Chart C

```{r}
rest_inspec |>
  filter(violation_code %in% c("06C", "06D", "06E", "06A","06F")) |>
  mutate(Date = format(inspection_date, "%Y-%m")) |>
  group_by(Date, violation_code) |>
  summarise(count = n()) |>
  ungroup() |>
  mutate(violation_code = violation_code |> fct_relevel("06C", "06D", "06E", "06A","06F")) |>
  mutate(violation_code = recode(violation_code, "06D" = "Food contact surface not properly washed, rinsed and sanitized","06C" = "Food not protected from potential source of contamination", "06F" = "Wiping cloths soiled or not stored in sanitizing solution", "06A" = "Personal cleanliness inadequate", "06E"= "Sanitized equipment or utensil improperly used or stored.")) |>
  plot_ly(x = ~Date, y = ~count,
          color = ~violation_code, type = "scatter", 
          mode = "lines", alpha = 1) |>
  layout(title =  "Mice Related Violations over Time in NYC Restaurants",
         xaxis = list(title = "Date"),
         yaxis = list(title = "Count"),
         font = list(size = 10)
         )
  
```

